version: 2
jobs:
  build:
    docker:
      - image: circleci/node:12.13.0
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - checkout
      - run: mkdir -p /tmp/workspace && echo $CIRCLE_BRANCH-$CIRCLE_BUILD_NUM > /tmp/workspace/docker-tag.txt
      - run: docker login quay.io/$CIRCLE_PROJECT_USERNAME -u $QUAY_USERNAME -p $QUAY_PASSWORD
      - run: docker build -t quay.io/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$(cat /tmp/workspace/docker-tag.txt) .
      - run: docker push quay.io/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$(cat /tmp/workspace/docker-tag.txt)
      - persist_to_workspace:
          root: /tmp/workspace
          paths:
            - docker-tag.txt

  deploy_task: &deploy_task
    machine: true
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run: docker login quay.io/$CIRCLE_PROJECT_USERNAME -u $QUAY_USERNAME -p $QUAY_PASSWORD
      - run: docker run --rm --name bk quay.io/quintype/bk-deploy $BK_ENVIRONMENT deployment $(cat /tmp/workspace/docker-tag.txt)

  deploy_malibu_integration_staging:
    <<: *deploy_task
    environment:
      BK_ENVIRONMENT: staging 1472

  lint_js:
    docker:
      - image: circleci/node:8.11
    steps:
      - checkout
      - run: npm install
      - run: npm run lint:js:ci
  lint_css:
    docker:
      - image: circleci/node:8.11
    steps:
      - checkout
      - run: npm install
      - run: npm run lint:css:ci


workflows:
  version: 2
  lint_check:
    jobs:
      - lint_js
      - lint_css

  build_and_deploy:
    jobs:
      - build:
          context: quay-login
      - hold_malibu_integration_staging_deploy:
          type: approval
          requires:
            - build
      - deploy_malibu_integration_staging:
          context: quay-login
          requires:
            - hold_malibu_integration_staging_deploy
          filters:
            branches:
              only:
                - platform-test-malibu

